<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv='Content-type' content='text/html; charset=utf-8'>
    <title>Conways Game of Life</title>
    <style>
      .cell {width: 15px;height: 15px; border: 0 solid white; border-width: 1px 2px 2px 1px;}
      table { 
    border-spacing: 0px;
    border-collapse: collapse;
}
    </style>
  </head>
  <body>
    <div id="container"></div>
    <script src="react.js"></script>
    <script src="JSXTransformer.js"></script>
    <script type="text/jsx">
      /**
       * @jsx React.DOM
       */

      function getRandomInt(max) {
        return Math.floor(Math.random() * max);
      }

      function getRandomColor(x, y) {
        var weights = colorWeights.map(function(f) {
          return Math.max(0, f(x, y));
        });
        var totalWeight = weights.reduce(function(prev, curr) { return prev + curr; });
        var random = Math.random() * totalWeight;
        var cumulativeWeight = 0;
        for (var i = 0; i < weights.length; i++) {
          cumulativeWeight += weights[i];
          if (random <= cumulativeWeight) {
            return i;
          }
        }
        throw new Error("impossible is nothing");
      }

      var leftWall = (18-1);
      var rightWall = (18+12);
      function afstandTotAchtermuurMax18(x) {
        if (x > leftWall && x < rightWall){return 0 ;}
        return Math.max(0, Math.min(
            Math.abs(x-leftWall),
            Math.abs(x-rightWall),
            24
        ));
      }

      function tiltedRamp(multiplier, tilt) {
        return function(x, y) {
          if (false && x > leftWall &&  x <= rightWall) {
            return multiplier * ( 1-  tilt);
          } else {
            return multiplier * (1 - tilt + 2 * tilt * afstandTotAchtermuurMax18(x) / (24));
          }
        };
      }

      var kleurnamen = [
        "wit",
        "grijs",
        "lichtblauw",
        "blauw",
        "zwart"
        ];
      var gridColors = ["#fff", "#ddd", "#6cf", "#00a", "#000"];
      var colorWeights= [
        tiltedRamp(25.0, 0.98),
        tiltedRamp(25.0, 0.93),
        tiltedRamp(30.0, 0),
        tiltedRamp(38.0, -1.02),
        tiltedRamp(3.0, -1.0),
      ];
      
      var numColors = gridColors.length;
      var breedte = 18+12+24+2;

      var hoogte = 25;

      var borderDikte = 2;
      var borderColor = "#fee"
      
      douchewand = [];
      function get(x, y) { return douchewand[y] ? douchewand[y][x] : undefined; }

      for(var y = 0; y < hoogte + 2* borderDikte ; y++) {
        douchewand[y] = []
        for(var x = 0; x < breedte + 2 * borderDikte; x++){
          douchewand[y][x] = -1;
        }
      }

      for(var y = borderDikte; y < hoogte ; y++) {
        for(var x = borderDikte; x < breedte; x++){
          douchewand[y][x] = getRandomColor(x - borderDikte, y - borderDikte);
        }
      }

      var numIterations = 1000;
      for (var i = 0; i < numIterations; i++) {
        var errors = 0;
        for(var y = borderDikte; y < hoogte + borderDikte; y++) {
          for(var x = borderDikte; x < breedte + borderDikte; x++){
            var color = get(x, y);
            if(get(x-1, y) == color || get(x+1, y) == color || get(x, y-1) == color || get(x, y+1) == color) {
              douchewand[y][x] = getRandomColor(x - borderDikte, y - borderDikte);
              ++errors;
            }
          }
        }
        console.info(errors)
        if (errors < 35){
          break;
        }
      }

      var Cell = React.createClass({
        onClick: function() {
          this.props.onClick();
        },

        render: function() {
            var color = (this.props.alive == -1) ? borderColor :  gridColors[this.props.alive];
            return <td className="cell" onClick={this.onClick} style={
              {
                'background-color': color,
                'border-right': (this.props.vertlines.includes(this.props.x+1-borderDikte) ? 'solid red 2px' : 'solid white 2px'),
                'border-bottom': (this.props.horlines.includes(this.props.y+1-borderDikte) ? 'solid red 2px' : 'solid white 2px')
              }
            } />;
        }
      });

      var Grid = React.createClass({
        onClick: function(x,y) {
          self = this;
          return function(){
            self.props.onClick(x, y)
          }
        },

        render: function() {
          var self = this;
          oc = this.onClick;
          var list_of_rows = this.props.grid.map(function(row, y){
            var row_of_cells = row.map(function(alive, x) {
              return <Cell alive={alive} x={x} y={y} key={""+y+","+x} vertlines={self.props.vertlines} horlines={self.props.horlines} onClick={oc(x, y)}/>;
            });
            return <tr key={y}>{row_of_cells}</tr>
          })

          return <table><tbody>{list_of_rows}</tbody></table>;
        }
      });

      var invertGridPoint = function(x, y, grid) {
        return grid.map(function(val, old_y) {
          if (old_y !== y) {
           return val;
         } else {
           return val.map(function(val, old_x) {
             if (old_x !== x) {
               return val;
             } else {
                return (val + 1) % gridColors.length;
             }
           });
         }
        });
      };

      var StenenTeller = React.createClass({
       
        render: function() {
          var counts = kleurnamen.map(function(){return 0;});

          var grid = this.props.grid;
          for (var y = 0; y < grid.length; y++)
            for (var x = 0; x < grid[y].length; x++)
              counts[grid[y][x]]++;
           var list_of_rows = kleurnamen.map(function(naam, i) {
              return <tr><td>{naam}</td><td>{counts[i]}</td></tr>;
            });
         
          return <table><tbody><tr><th>kleur</th><th>aantal</th></tr>{list_of_rows}</tbody></table>;
        }
      });

      var ClickableGrid = React.createClass({
         getInitialState: function(){
           return {
             grid: this.props.startingGrid,
           };
         },
                  
         onClick: function(x, y){
           new_grid = invertGridPoint(x,y,this.state.grid);
           this.setState({grid: new_grid});
         },

         render: function(){
           return <div>
                   <Grid grid={this.state.grid} vertlines={[0, 18, 18+12, 18+12+24, 18+12+24+2]} horlines={[0, 25]} onClick={this.onClick}/>
                   <br/><br/><br/>
                   <StenenTeller grid={this.state.grid} />
                   <pre>{JSON.stringify(this.state.grid)}</pre>
                   </div>
          }
        })

      


      React.renderComponent(
        <ClickableGrid startingGrid={douchewand} />,
        document.getElementById('container')
      );
    </script>
  </body>
</html>
